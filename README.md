# IAM Set Analyzer

The IAM Set Analyzer is a tool designed to determine the effective permissions of AWS IAM policies. The logic behind the tool is based on a series of articles that I have written called [IAM and Set Theory](https://colinandrewstechblog.vercel.app/).

The basic idea is that you can use set theory to understand what IAM actions an IAM policy is trying to describe and what the final effect on those actions should be. The set theory mindset can be expanded and applied to all of AWS' Policy Evaluation Logic, which is seeking to identify unions or intersections of the sets described by policies as applied to roles, with policies as applied to permissions boundaries or Service Control Policies. 

## Setting up

- [Install uv](https://github.com/astral-sh/uv)
- Clone the repository to your local machine
- execute `uv venv` to create a new virtual environment in the project folder
- execute `uv sync` to install the project dependencies 

## Getting started

Before using the tool, you first need to scrape the AWS Service Authorisation Reference. We scrape the authorisation reference pages because they contain important data about the relationship between `resources` and `actions` which might not be apparent in the JSON representation of the data provided by AWS.

```
python scrape_iam_actions/scrape_service_auth.py
```

And then we need to process this data a little bit so it is ready to consume by the tool:

```
python scrape_iam_actions/load_service_auth.py
```

## Using the tool

This is a Python project managed with `uv`. Clone the repository to your local machine and use `uv` to install the project dependencies. 

Currently there are two ways to use the tool. 

By supplying a policy to analyse:
```
python iam_set_analyzer.py --policy /path/to/your-policy.json
```


By supplying a policy and a list of boundaries (i.e. SCPs or permission boundaries):
```
python iam_set_analyzer.py --policy /path/to/your-policy.json --boundaries /path/to/your-boundary.json path/to/your-next-boundary.json
```

The result is a file called `report.html` which appears in the root of this directory. Opening this page in your browser presents you with the overly complicated and very ugly results generated by the tool.

# Understanding the tool's output

## Policy and boundary policies

For convenience, these two blocks just render the json that was input into the tool.

## Effective permissions

This is the primary output of the tool. It is created by converting a Pandas DataFrame to a json object and then rendering that into a Jinja2 html template. This process results in the columns being displayed in alphabetical order, which removes the context the program adds as it modifies the data structure. These are the sorts of columns you can expect to find:

| Column name | Intention |
| --- | --- |
| Actions | The list of **Valid** IAM actions described by the input policy (not the boundary policies) |
| Effect* | Columns starting with effect are making a statement about whether the Action is allowed or denied. The suffix `_allow` tells you there is a valid Allow statement in the input policy, and `_deny` tells you there is a valid Deny in the input policy. `Effect` is the logical result for the input policy. The `Effect_final` column is the result *after* any boundary policies have been applied. |
| Exist | This is a column created by the Pandas `merge` function, and tells you a bit about which statements the Actions came from. |
| Resource types (*required)_ | These columns are from the Service Authorsation reference, and tell you what resource types are relevant to an Action |
| Required resources_* | These columns identify the **required** resources for an action |
| Optional resources_* | These columns identify the optional resources for an action |
| Maybe_* | See the note below|
| Prefix | The AWS service which the action is from |
| resource_service_* | The AWS service which the *resource* for an action is from. e.g. STS has an AssumeRole action, which is related to an IAM role resource |

## The Maybe_ column

This column is based on the logic from the [inside-out IAM policies](https://colinandrewstechblog.vercel.app/posts/iam-and-set-theory-part-03) article. 

> There are actions for which no specific resource is required, but instead are optional. If any resources in our statement is present for such an action, then that action will be available to us.

So, if a policy statement describes an action and a corresponding set of resources for which the action itself has a set of optional resources (according to the authorisation reference), then the statement is valid if any one of the resources described is present in the set of optional resources. 

# Advantages of this tool over others

Perhaps the most complicated thing about IAM is the relationship between actions and resources. One thing this tool does that is different from others is identify when your policy lacks sufficient permissions to perform an action due to the lack of access resources. 

For example, in order to call `ec2:RunInstances` you need to have access to `image, instance, network-interface, security-group, and subnet` at a minimum. If you do not, then your attempt to create the instance will fail. For example:


This would succeed (although not allow you to attach a volume)
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:RunInstances"
            ],
            "Resource": [
                "arn:aws:ec2:*:*:instance/*",
                "arn:aws:ec2:*:*:network-interface/*",
                "arn:aws:ec2:*:*:subnet/*",
                "arn:aws:ec2:*:*:security-group/*",
                "arn:aws:ec2:*::image/*"
            ]
        }
    ]
}
```

This would fail
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:RunInstances"
            ],
            "Resource": [
                "arn:aws:ec2:*:*:instance/*"
            ]
        }
    ]
}
```

# Moving forward

Analyser ... Analyzer ... I'm from Australia, so I prefer "s", but AWS uses "z", so I have kept my spelling of the word as *in*consistent as possible.
